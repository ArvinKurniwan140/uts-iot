<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Hidroponik IoT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .card h2::before {
            content: 'ðŸ“Š';
            margin-right: 10px;
            font-size: 24px;
        }
        
        .sensor-value {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin: 15px 0;
        }
        
        .sensor-unit {
            font-size: 20px;
            color: #666;
        }
        
        .timestamp {
            color: #999;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .control-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .btn-on {
            background: #10b981;
            color: white;
        }
        
        .btn-on:hover {
            background: #059669;
        }
        
        .btn-off {
            background: #ef4444;
            color: white;
        }
        
        .btn-off:hover {
            background: #dc2626;
        }
        
        .btn-refresh {
            background: #667eea;
            color: white;
        }
        
        .btn-refresh:hover {
            background: #5568d3;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-normal {
            background: #10b981;
            color: white;
        }
        
        .status-warning {
            background: #f59e0b;
            color: white;
        }
        
        .status-danger {
            background: #ef4444;
            color: white;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background: #f3f4f6;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŒ± Dashboard Monitoring Hidroponik IoT</h1>
        
        <div class="dashboard" id="sensorCards">
            <div class="card">
                <h2>Suhu</h2>
                <div class="sensor-value" id="suhuValue">--</div>
                <div class="sensor-unit">Â°C</div>
                <div class="timestamp" id="suhuTime">Memuat data...</div>
            </div>
            
            <div class="card">
                <h2>Kelembapan</h2>
                <div class="sensor-value" id="kelembapanValue">--</div>
                <div class="sensor-unit">%</div>
                <div class="timestamp" id="kelembapanTime">Memuat data...</div>
            </div>
            
            <div class="card">
                <h2>Kecerahan</h2>
                <div class="sensor-value" id="luxValue">--</div>
                <div class="sensor-unit">Lux</div>
                <div class="timestamp" id="luxTime">Memuat data...</div>
            </div>
        </div>
        
        <div class="control-panel">
            <h2>âš¡ Panel Kontrol Pompa <span class="status status-normal" id="pompaStatus">OFF</span></h2>
            <button class="btn btn-on" onclick="controlPompa(true)">Nyalakan Pompa</button>
            <button class="btn btn-off" onclick="controlPompa(false)">Matikan Pompa</button>
            <button class="btn btn-refresh" onclick="fetchLatestData()">ðŸ”„ Refresh Data</button>
        </div>
        
        <div class="data-table">
            <h2 style="color: #667eea; margin-bottom: 20px;">ðŸ“œ Riwayat Data Sensor (10 Data Terakhir)</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Suhu (Â°C)</th>
                        <th>Kelembapan (%)</th>
                        <th>Kecerahan (Lux)</th>
                        <th>Waktu</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center;">Memuat data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Konfigurasi API endpoint
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // Fungsi untuk fetch data sensor terbaru
        async function fetchLatestData() {
            try {
                const response = await fetch(`${API_BASE_URL}/sensor/latest`);
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const data = result.data;
                    
                    // Update tampilan sensor values
                    document.getElementById('suhuValue').textContent = data.suhu.toFixed(1);
                    document.getElementById('kelembapanValue').textContent = data.kelembapan.toFixed(1);
                    document.getElementById('luxValue').textContent = data.lux.toFixed(0);
                    
                    // Update timestamp
                    const time = new Date(data.timestamp).toLocaleString('id-ID');
                    document.getElementById('suhuTime').textContent = `Update: ${time}`;
                    document.getElementById('kelembapanTime').textContent = `Update: ${time}`;
                    document.getElementById('luxTime').textContent = `Update: ${time}`;
                    
                    console.log('Data sensor terbaru:', data);
                } else {
                    console.error('Gagal mengambil data:', result.message);
                }
            } catch (error) {
                console.error('Error fetching latest data:', error);
                alert('Gagal mengambil data dari server. Pastikan backend sudah berjalan.');
            }
        }
        
        // Fungsi untuk fetch semua data sensor
        async function fetchAllData() {
            try {
                const response = await fetch(`${API_BASE_URL}/sensor/data`);
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const tableBody = document.getElementById('dataTableBody');
                    tableBody.innerHTML = '';
                    
                    // Tampilkan 10 data terakhir
                    const limitedData = result.data.slice(0, 10);
                    
                    limitedData.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.id}</td>
                            <td>${item.suhu.toFixed(1)}</td>
                            <td>${item.kelembapan.toFixed(1)}</td>
                            <td>${item.lux.toFixed(0)}</td>
                            <td>${new Date(item.timestamp).toLocaleString('id-ID')}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    console.log('Semua data sensor:', result.data);
                }
            } catch (error) {
                console.error('Error fetching all data:', error);
            }
        }
        
        // Fungsi kontrol pompa
        async function controlPompa(state) {
            try {
                const response = await fetch(`${API_BASE_URL}/control/pompa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ state: state })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const statusEl = document.getElementById('pompaStatus');
                    statusEl.textContent = state ? 'ON' : 'OFF';
                    statusEl.className = `status ${state ? 'status-danger' : 'status-normal'}`;
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error controlling pompa:', error);
                alert('Gagal mengontrol pompa. Periksa koneksi server.');
            }
        }
        
        // Auto refresh setiap 5 detik
        function autoRefresh() {
            fetchLatestData();
            fetchAllData();
        }
        
        // Jalankan saat halaman dimuat
        window.onload = function() {
            autoRefresh();
            setInterval(autoRefresh, 5000); // Refresh setiap 5 detik
        };
    </script>
</body>
</html>